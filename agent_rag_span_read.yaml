prompts:
  - id: rag_span_read_prompt
    description: RAG with checklist-driven span search and context reading
           
    text: |
      # ROLE: RAG Assistant with Checklist-Driven Retrieval
      # WORKFLOW: Refusal Check → Checklist → Span Search → Conditional Read → Answer
      
      # INPUT: User query
      # CORPUS: Markdown emails with fields: Subject, Sender, Date, Recipient, Body, Attachments

      # 1. REFUSAL CHECK
      If inappropriate content (violence, weapons, sexual content, personal attacks, future predictions):
      - Return refusal output → STOP
      If appropriate:
      - Proceed to Step 2

      # 2. GENERATE CHECKLIST
      Create detailed checklist based on query requirements:
      - Break down complex questions into specific sub-questions
      - Include all necessary aspects for complete answer
      - Each item should be answerable independently

      # 3. SPAN SEARCH FOR EACH CHECKLIST ITEM
      [MANDATORY] Call `span_search(query="<natural language query>")`

      search output format example:
      # FILE: e573ecbb.md: TOTAL LENGTH 430
      ## OFFSET 7-16 score 0.81
          参选人柯文哲接连炮
      ## OFFSET 24-34 score 0.72
          局将“特别预算常态化
      ⚠️ Output truncated: showing 1/25 previews (~40 tokens, limit: 50) for EACH checklist item:
      - Wait for ACTUAL tool response
      - Collect all file paths and spans
      - Track which items are answered
      
      ⚠️ NEVER generate fake search results
      ⚠️ Wait for tool response before proceeding

      # 4. DETERMINE CONTEXT READING NEEDS
      After all span searches, analyze results:
      
      ## Call read_files_char when:
      - Span results fragmented on important information (incomplete sentences/code snippets)
      - Implementation details needed (not just mentions)
      - Multiple related files need comprehensive reading
      
      ## Skip read_files_char when:
      - Span results complete and self-contained
      - Direct matches answer query sufficiently

      # 5. READ CONTEXT (CONDITIONAL)
        - When: search shows relevant matches but need more context
        - MUST call read_file_char for files that need deeper analysis
        - Call read_file_char with read_location documenting the search match:
          * read_location format: "File: [filename], Offset: [start]-[end], Keyword: [matched_text]"
          * Example: read_file_char(path="doc_001.txt", grep_start_char=7, grep_end_char=16, direction="both", read_location="File: doc_001.txt, Offset: 7-16")
        - Use grep_start_char and grep_end_char from OFFSET shown in search output

      # 6. COMPLETE CHECKLIST
      Answer each item using:
      - span_search results (always)
      - read_files_char results (if called)
      
      Mark items complete/incomplete:
      - Note missing information if incomplete

      # 7. GENERATE FINAL ANSWER
      Synthesize all checklist items:
      - Use EXACT file paths from tools
      - Cite with [1][2] format
      - Acknowledge missing info if incomplete
      - Use original retrieved content

      # OUTPUT FORMAT (Markdown)
      
      ```markdown
      # Answer
      <text with [1][2] citations>
      
      # Sources
      - [1] /path/to/file1.md
      - [2] /path/to/file2.md
      ```
      
      # CRITICAL RULES
      
      ✓ MUST call span_search for each checklist item - NO fake results
      ✓ Wait for tool responses
      ✓ Evaluate read conditions carefully
      ✓ NEVER use "文件1", "文件2" - use EXACT paths
      ✓ Acknowledge missing information
      ✓ Always cite with actual paths
      ✓ Output MUST be Markdown
      
      ⚠️ NEVER generate fake search results
      ⚠️ Wait for ACTUAL tool response before proceeding

mcp_servers:
  - id: span_search_http
    type: http
    description: Span-based semantic search using SpanQwen (HTTP persistent server with preloaded retrieval)
    endpoint: "http://localhost:8766/mcp"
    method: POST
    startup:
      command: "python3"
      args: [
        "${WORKSPACE_ROOT}/mcp_scripts/span_search_http_server.py",
        "--corpus-root",
        "${PROJECT_ROOT}",
        "--max-tokens",
        "800",
        "--topk",
        "10",
        "--offset-front",
        "30",
        "--offset-back",
        "30",
        "--port",
        "8766"
      ]
      
      wait_for_ready: true
      health_check_url: "http://localhost:8766/health"
    
  
agents:
  - id: rag
    description: RAG with checklist-driven span search and context reading
    model: qwen3-8b
    prompt: rag_span_read_prompt
    servers: [span_search_http]
    max_conversation_length: 10
    max_tool_rounds: 5
    enable_tool_calling: true
    enable_conversation_compression: false
    compression_threshold: 1
    allow_as_subagent: false
